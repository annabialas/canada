<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script src="https://d3js.org/d3.v3.min.js"></script>
<script src="https://d3js.org/topojson.v1.min.js"></script>
<link href='https://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>
<style>

  .path {
    fill: #E1E1E1;
    stroke: #E1E1E1;
    stroke-linecap: round;
    stroke-linejoin: round;
  }

  .feature { 
    cursor: pointer; 
    fill: #a897bf; 
    opacity: .7; 
  }

  .active { fill: #FF0000; }

  .number{
    fill:#FFF;
    font-size:16;
    font-family: 'Montserrat';
  }

  div.tooltip {   
    position: absolute;           
    text-align: center;           
    max-width: 120px;                                  
    padding: 5px 10px;             
    font: 12px 'Montserrat', sans-serif;        
    background: white;   
    border: 0px;        
    pointer-events: none;         
  }
  
</style>
</head>
<body>
<script type="text/JavaScript">

/* Based on the Social Innovation Simulation Tutorial Available at http://socialinnovationsimulation.com/2013/07/11/tutorial-making-maps-on-d3/ */

var w = 800;
var h = 800;
active = d3.select(null);
var svg = d3.select("body")
  .append("svg")
  .attr("width", w)
  .attr("height", h)

      // .call(d3.behavior.zoom().on("zoom", function () {
      //   svg.attr("transform", "translate(" + d3.event.translate + ")" + " scale(" + d3.event.scale + ")")
      // }))
      // .append("g");
	
var projection = d3.geo.azimuthalEqualArea()
	.rotate([100, -45])
	.center([5, 20])
	.scale(800)
	.translate([w/2, h/2]);

	
var path = d3.geo.path()
	.projection(projection);

var div = d3.select("body")
        .append("div")   
        .attr("class", "tooltip");               
        

	
d3.json("https://raw.githubusercontent.com/mdgnkm/SIG-Map/master/canada.json", function(canada) {

	svg.selectAll("append")
		.data(canada.features)
		.enter()
		.append("path")
		.attr("d", path)
		.attr("class", "path")

	d3.csv("companies.csv", function(data) {

			svg.selectAll("circle")
              .data(data)
              .enter()
              .append("circle")
              .attr("class", "feature")
              .attr("cx", function(d) {
                  return projection([d.LON, d.LAT])[0];
              })
              .attr("cy", function(d) {
                  return projection([d.LON, d.LAT])[1];
              })
              .attr("r", function(d) {
                  return Math.sqrt(d.PNUMBER)*15;
              })


              .on("mouseover", function(d) {      
                    div.transition()        
                      .duration(200)      
                      .style("opacity", 1)
                      .style("left", (d3.event.pageX) + "px")     
                      .style("top", (d3.event.pageY - 28) + "px")         
                      if (d.PNUMBER==1) { 
                          div.html(d.PROVINCE + "<br>" + d.PNUMBER + " company")
                      }
                      else { 
                          div.html(d.PROVINCE + "<br>" + d.PNUMBER + " companies")
                      }
                    d3.select(this)
                      .transition()            
                      .delay(0)            
                      .duration(750)
                      .attr("r", function(d) {
                          return Math.sqrt(d.PNUMBER) * 20;
                      })
                  })
  
              .on("mouseout", function(d) {       
                  div.transition()        
                     .duration(500)      
                     .style("opacity", 0) 
                  d3.select(this)
                      .transition()
                      .duration(750)
                      .attr("r", function(d) {
                          return Math.sqrt(d.PNUMBER) * 15;
                      }) 
              })

              .on("click", clicked)

              svg.selectAll("text")
               .data(data)
               .enter()
               .append("text")
                 .attr("x", function(d) {
                   return projection([d.LON, d.LAT])[0];
                 })
                 .attr("y", function(d) {
                   return projection([d.LON, d.LAT])[1];
                 })
                 .attr("dy", ".32em")
                 .attr("dx", function(d){
                    if (d.PNUMBER < 4) { return "-.22em" }
                    else if (d.PNUMBER == 6) { return "-.35em" }
                    else { return "-.6em" }
                 })
                 .text(function(d) { return d.PNUMBER; })
                 .attr("class", "number")

              function clicked() {
                    if (active.node() === this) return reset();
                    active.classed("active", false);
                    active = d3.select(this).classed("active", true);
              }

              function reset() { 
                    active.classed("active", false);
                    active = d3.select(null);                
              }   

              // .on("mouseover", expand)
              // .on("mouseout", contract)

              // function expand(){
              //       d3.select(this)
              //           .transition()            
              //           .delay(0)            
              //           .duration(750)
              //           .attr("r", function(d) {
              //               return Math.sqrt(d.PNUMBER) * 15;
              //           })
              // }

              // function contract(){
              //       d3.select(this)
              //           .transition()
              //           .duration(750)
              //           .attr("r", function(d) {
              //               return Math.sqrt(d.PNUMBER) * 10;
              //           }) 
              // }             

	});


});

	


</script>
</body>
</html>